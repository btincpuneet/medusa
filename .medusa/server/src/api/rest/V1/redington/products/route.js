"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GET = exports.OPTIONS = void 0;
const setCors = (req, res) => {
    const origin = req.headers.origin;
    if (origin) {
        res.header("Access-Control-Allow-Origin", origin);
        res.header("Vary", "Origin");
    }
    else {
        res.header("Access-Control-Allow-Origin", "*");
    }
    res.header("Access-Control-Allow-Headers", req.headers["access-control-request-headers"] ||
        "Content-Type, Authorization");
    res.header("Access-Control-Allow-Methods", "GET,OPTIONS");
    res.header("Access-Control-Allow-Credentials", "true");
};
const toMajorUnits = (amount) => {
    const value = Number(amount ?? 0);
    if (!Number.isFinite(value)) {
        return 0;
    }
    return Number((value / 100).toFixed(2));
};
const parseFilters = (query) => {
    const filters = {};
    for (const [key, value] of Object.entries(query)) {
        const match = key.match(/searchCriteria\[filter_groups\]\[(\d+)\]\[filters\]\[(\d+)\]\[field\]/);
        if (match) {
            const prefix = `searchCriteria[filter_groups][${match[1]}][filters][${match[2]}]`;
            const fieldName = String(value);
            const filterValue = query[`${prefix}[value]`];
            if (fieldName && filterValue !== undefined) {
                filters[fieldName] = Array.isArray(filterValue)
                    ? filterValue[0]
                    : String(filterValue);
            }
        }
    }
    return filters;
};
const parsePagination = (query) => {
    const pageSizeKey = Object.keys(query).find((key) => key.endsWith("[pageSize]"));
    const currentPageKey = Object.keys(query).find((key) => key.endsWith("[currentPage]"));
    const take = Number(pageSizeKey ? query[pageSizeKey] : query.pageSize ?? query.page_size);
    const page = Number(currentPageKey
        ? query[currentPageKey]
        : query.currentPage ?? query.current_page) || 1;
    return {
        skip: take && Number.isFinite(take) ? (page - 1) * take : 0,
        take: take && Number.isFinite(take) ? take : 20,
    };
};
const formatProduct = (product) => {
    const variant = product.variants?.[0] ?? {};
    const prices = variant.prices ?? [];
    const priceAmount = prices.length ? prices[0].amount : 0;
    const categories = product.categories ?? [];
    const metadata = product.metadata ?? {};
    return {
        id: product.id,
        variant_id: variant.id ?? null,
        sku: variant.sku ?? product.handle ?? product.id,
        name: product.title,
        status: product.status ?? 1,
        visibility: 4,
        price: toMajorUnits(priceAmount),
        type_id: variant.options?.length ? "configurable" : "simple",
        custom_attributes: [
            {
                attribute_code: "small_image",
                value: product.thumbnail ?? "",
            },
            {
                attribute_code: "image",
                value: product.images?.[0]?.url ?? product.thumbnail ?? "",
            },
        ],
        extension_attributes: {
            stock_item: {
                qty: variant.inventory_quantity ?? metadata.inventory ?? 0,
            },
            product_category: categories[0]?.id ?? null,
            category_links: categories.map((category) => ({
                category_id: category.id,
                position: 0,
            })),
            on_home: metadata.on_home ?? 0,
        },
    };
};
const OPTIONS = async (req, res) => {
    setCors(req, res);
    res.status(204).send();
};
exports.OPTIONS = OPTIONS;
const GET = async (req, res) => {
    setCors(req, res);
    let productModule = null;
    let legacyProductService = null;
    try {
        productModule = req.scope.resolve("product");
    }
    catch {
        productModule = null;
    }
    if (!productModule) {
        try {
            legacyProductService = req.scope.resolve("productService");
        }
        catch {
            legacyProductService = null;
        }
    }
    if (!productModule && !legacyProductService) {
        return res.status(500).json({
            message: "Product module/service is not available.",
        });
    }
    const { skip, take } = parsePagination(req.query);
    const filters = parseFilters(req.query);
    const selector = {};
    let products = [];
    let count = 0;
    if (productModule) {
        ;
        [products, count] = await productModule.listAndCountProducts(selector, {
            relations: ["variants", "variants.prices", "categories"],
            skip,
            take,
        });
    }
    else if (legacyProductService) {
        ;
        [products, count] = await legacyProductService.listAndCount(selector, {
            relations: ["variants", "variants.prices", "categories"],
            skip,
            take,
        });
    }
    let items = products;
    if (filters.category_id) {
        items = items.filter((product) => (product.categories || []).some((category) => category.id === filters.category_id));
    }
    if (filters.on_home) {
        items = items.filter((product) => String(product.metadata?.on_home ?? "") === String(filters.on_home));
    }
    return res.json({
        items: items.map(formatProduct),
        total_count: count,
    });
};
exports.GET = GET;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9zcmMvYXBpL3Jlc3QvVjEvcmVkaW5ndG9uL3Byb2R1Y3RzL3JvdXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUdBLE1BQU0sT0FBTyxHQUFHLENBQUMsR0FBa0IsRUFBRSxHQUFtQixFQUFFLEVBQUU7SUFDMUQsTUFBTSxNQUFNLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUE7SUFDakMsSUFBSSxNQUFNLEVBQUUsQ0FBQztRQUNYLEdBQUcsQ0FBQyxNQUFNLENBQUMsNkJBQTZCLEVBQUUsTUFBTSxDQUFDLENBQUE7UUFDakQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDLENBQUE7SUFDOUIsQ0FBQztTQUFNLENBQUM7UUFDTixHQUFHLENBQUMsTUFBTSxDQUFDLDZCQUE2QixFQUFFLEdBQUcsQ0FBQyxDQUFBO0lBQ2hELENBQUM7SUFFRCxHQUFHLENBQUMsTUFBTSxDQUNSLDhCQUE4QixFQUM5QixHQUFHLENBQUMsT0FBTyxDQUFDLGdDQUFnQyxDQUFDO1FBQzNDLDZCQUE2QixDQUNoQyxDQUFBO0lBQ0QsR0FBRyxDQUFDLE1BQU0sQ0FBQyw4QkFBOEIsRUFBRSxhQUFhLENBQUMsQ0FBQTtJQUN6RCxHQUFHLENBQUMsTUFBTSxDQUFDLGtDQUFrQyxFQUFFLE1BQU0sQ0FBQyxDQUFBO0FBQ3hELENBQUMsQ0FBQTtBQUVELE1BQU0sWUFBWSxHQUFHLENBQUMsTUFBVyxFQUFFLEVBQUU7SUFDbkMsTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLE1BQU0sSUFBSSxDQUFDLENBQUMsQ0FBQTtJQUNqQyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO1FBQzVCLE9BQU8sQ0FBQyxDQUFBO0lBQ1YsQ0FBQztJQUNELE9BQU8sTUFBTSxDQUFDLENBQUMsS0FBSyxH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