"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.clearCustomerSession = exports.persistCustomerSession = exports.requireCustomerSession = exports.getCustomerSession = void 0;
const utils_1 = require("@medusajs/framework/utils");
const legacy_auth_1 = require("../../utils/legacy-auth");
const COOKIE_NAME = legacy_auth_1.CUSTOMER_SESSION_COOKIE;
const DEFAULT_MAX_AGE = 24 * 60 * 60 * 1000; // 1 day fallback
const resolveSecureFlag = () => {
    const secureEnv = process.env.CUSTOMER_SESSION_SECURE?.toLowerCase();
    if (secureEnv === "true") {
        return true;
    }
    if (secureEnv === "false") {
        return false;
    }
    return process.env.NODE_ENV === "production";
};
const resolveSameSite = (secure) => {
    const configured = process.env.CUSTOMER_SESSION_SAMESITE?.toLowerCase();
    if (configured === "strict" || configured === "lax") {
        return configured;
    }
    if (configured === "none" && secure) {
        return "none";
    }
    if (secure) {
        return "none";
    }
    return "lax";
};
const resolveMaxAge = () => {
    const raw = process.env.CUSTOMER_SESSION_MAX_AGE_MS;
    const parsed = raw ? Number(raw) : NaN;
    if (Number.isFinite(parsed) && parsed > 0) {
        return Math.floor(parsed);
    }
    return DEFAULT_MAX_AGE;
};
const COOKIE_OPTIONS = (() => {
    const secure = resolveSecureFlag();
    const sameSite = resolveSameSite(secure);
    const maxAge = resolveMaxAge();
    return {
        httpOnly: true,
        secure,
        sameSite,
        maxAge,
        path: "/",
    };
})();
const readTokenFromRequest = (req) => {
    const cookieToken = req.cookies?.[COOKIE_NAME];
    if (cookieToken) {
        return cookieToken;
    }
    const authHeader = typeof req.headers["authorization"] === "string"
        ? req.headers["authorization"].trim()
        : "";
    if (authHeader) {
        const bearerMatch = authHeader.match(/^Bearer\s+(.+)$/i);
        if (bearerMatch) {
            return bearerMatch[1].trim();
        }
        return authHeader;
    }
    const sessionToken = req.session?.["customer_token"];
    if (typeof sessionToken === "string") {
        return sessionToken;
    }
    return null;
};
const getCustomerSession = (req) => {
    const token = readTokenFromRequest(req);
    const payload = (0, legacy_auth_1.verifyCustomerToken)(token);
    if (!payload || typeof payload.email !== "string") {
        return null;
    }
    if (payload.actor_type && payload.actor_type !== "customer") {
        return null;
    }
    return {
        ...payload,
        email: payload.email,
    };
};
exports.getCustomerSession = getCustomerSession;
const requireCustomerSession = (req) => {
    const session = (0, exports.getCustomerSession)(req);
    if (!session) {
        throw new utils_1.MedusaError(utils_1.MedusaError.Types.UNAUTHORIZED, "Customer session is missing or invalid.");
    }
    return session;
};
exports.requireCustomerSession = requireCustomerSession;
const persistCustomerSession = (res, token) => {
    const response = res;
    if (typeof response.cookie === "function") {
        response.cookie(COOKIE_NAME, token, COOKIE_OPTIONS);
        return;
    }
    const cookieString = `${COOKIE_NAME}=${token}; Max-Age=${COOKIE_OPTIONS.maxAge}; Path=/; HttpOnly${COOKIE_OPTIONS.secure ? "; Secure" : ""}${COOKIE_OPTIONS.sameSite ? `; SameSite=${COOKIE_OPTIONS.sameSite}` : ""}`;
    res.setHeader("Set-Cookie", cookieString);
};
exports.persistCustomerSession = persistCustomerSession;
const clearCustomerSession = (res) => {
    const response = res;
    if (typeof response.clearCookie === "function") {
        response.clearCookie(COOKIE_NAME, {
            ...COOKIE_OPTIONS,
            maxAge: 0,
        });
        return;
    }
    res.setHeader("Set-Cookie", `${COOKIE_NAME}=; Max-Age=0; Path=/; HttpOnly${COOKIE_OPTIONS.secure ? "; Secure" : ""}`);
};
exports.clearCustomerSession = clearCustomerSession;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Vzc2lvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9hcGkvcmVkaW5ndG9uL3V0aWxzL3Nlc3Npb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EscURBQXVEO0FBR3ZELHlEQUlnQztBQUVoQyxNQUFNLFdBQVcsR0FBRyxxQ0FBdUIsQ0FBQTtBQUMzQyxNQUFNLGVBQWUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUEsQ0FBQyxpQkFBaUI7QUFZN0QsTUFBTSxpQkFBaUIsR0FBRyxHQUFHLEVBQUU7SUFDN0IsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsRUFBRSxXQUFXLEVBQUUsQ0FBQTtJQUNwRSxJQUFJLFNBQVMsS0FBSyxNQUFNLEVBQUUsQ0FBQztRQUN6QixPQUFPLElBQUksQ0FBQTtJQUNiLENBQUM7SUFDRCxJQUFJLFNBQVMsS0FBSyxPQUFPLEVBQUUsQ0FBQztRQUMxQixPQUFPLEtBQUssQ0FBQTtJQUNkLENBQUM7SUFDRCxPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxLQUFLLFlBQVksQ0FBQTtBQUM5QyxDQUFDLENBQUE7QUFFRCxNQUFNLGVBQWUsR0FBRyxDQUFDLE1BQWUsRUFBNkIsRUFBRTtJQUNyRSxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLHlCQUF5QixFQUFFLFdBQVcsRUFBRSxDQUFBO0lBQ3ZFLElBQUksVUFBVSxLQUFLLFFBQVEsSUFBSSxVQUFVLEtBQUssS0FBSyxFQUFFLENBQUM7UUFDcEQsT0FBTyxVQUFVLENBQUE7SUFDbkIsQ0FBQztJQUNELElBQUksVUFBVSxLQUFLLE1BQU0sSUFBSSxNQUFNLEVBQUUsQ0FBQztRQUNwQyxPQUFPLE1BQU0sQ0FBQTtJQUNmLENBQUM7SUFDRCxJQUFJLE1BQU0sRUFBRSxDQUFDO1FBQ1gsT0FBTyxNQUFNLENBQUE7SUFDZixDQUFDO0lBQ0QsT0FBTyxLQUFLLENBQUE7QUFDZCxDQUFDLENBQUE7QUFFRCxNQUFNLGFBQWEsR0FBRyxHQUFHLEVBQUU7SUFDekIsTUFBTSxHQUFHLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQywyQkFBMkIsQ0FBQTtJQUNuRCxNQUFNLE1BQU0sR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFBO0lBQ3RDLElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7UUFDMUMsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFBO0lBQzNCLENBQUM7SUFDRCxPQUFPLGVBQWUsQ0FBQTtBQUN4QixDQUFDLENBQUE7QUFFRCxNQUFNLGNBQWMsR0FBa0IsQ0FBQyxHQUFHLEVBQUU7SUFDMUMsTUFBTSxNQUFNLEdBQUcsaUJBQWlCLEVBQUUsQ0FBQTtJQUNsQyxNQUFNLFFBQVEsR0FBRyxlQUFlLENBQUMsTUFBTSxDQUFDLENBQUE7SUFDeEMsTUFBTSxNQUFNLEdBQUcsYUFBYSxFQUFFLENBQUE7SUFFOUIsT0FBTztRQUNMLFFBQVEsRUFBRSxJQUFJO1FBQ2QsTUFBTTtRQUNOLFFBQVE7UUFDUixNQUFNO1FBQ04sSUFBSSxFQUFFLEdBQUc7S0FDVixDQUFBO0FBQ0gsQ0FBQyxDQUFDLEVBQUUsQ0FBQTtBQUVKLE1BQU0sb0JBQW9CLEdBQUcsQ0FBQyxHQUF1QixFQUFpQixFQUFFO0lBQ3RFLE1BQU0sV0FBVyxHQUFHLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxXQUFXLENBQUMsQ0FBQTtJQUM5QyxJQUFJLFdBQVcsRUFBRSxDQUFDO1FBQ2hCLE9BQU8sV0FBVyxDQUFBO0lBQ3BCLENBQUM7SUFFRCxNQUFNLFVBQVUsR0FDZCxPQUFPLEdBQUcsQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLEtBQUssUUFBUTtRQUM5QyxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQyxJQUFJLEVBQUU7UUFDckMsQ0FBQyxDQUFDLEVBQUUsQ0FBQTtJQUVSLElBQUksVUFBVSxFQUFFLENBQUM7UUFDZixNQUFNLFdBQVcsR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLENBQUE7UUFDeEQsSUFBSSxXQUFXLEVBQUUsQ0FBQztZQUNoQixPQUFPLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQTtRQUM5QixDQUFDO1FBQ0QsT0FBTyxVQUFVLENBQUE7SUFDbkIsQ0FBQztJQUVELE1BQU0sWUFBWSxHQUFHLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFBO0lBQ3BELElBQUksT0FBTyxZQUFZLEtBQUssUUFBUSxFQUFFLENBQUM7UUFDckMsT0FBTyxZQUFZLENBQUE7SUFDckIsQ0FBQztJQUVELE9BQU8sSUFBSSxDQUFBO0FBQ2IsQ0FBQyxDQUFBO0FBTU0sTUFBTSxrQkFBa0IsR0FBRyxDQUNoQyxHQUFrQixFQUNlLEVBQUU7SUFDbkMsTUFBTSxLQUFLLEdBQUcsb0JBQW9CLENBQUMsR0FBeUIsQ0FBQyxDQUFBO0lBQzdELE1BQU0sT0FBTyxHQUFHLElBQUEsaUNBQW1CLEVBQUMsS0FBSyxDQUFDLENBQUE7SUFFMUMsSUFBSSxDQUFDLE9BQU8sSUFBSSxPQUFPLE9BQU8sQ0FBQyxLQUFLLEtBQUssUUFBUSxFQUFFLENBQUM7UUFDbEQsT0FBTyxJQUFJLENBQUE7SUFDYixDQUFDO0lBRUQsSUFBSSxPQUFPLENBQUMsVUFBVSxJQUFJLE9BQU8sQ0FBQyxVQUFVLEtBQUssVUFBVSxFQUFFLENBQUM7UUFDNUQsT0FBTyxJQUFJLENBQUE7SUFDYixDQUFDO0lBRUQsT0FBTztRQUNMLEdBQUcsT0FBTztRQUNWLEtBQUssRUFBRSxPQUFPLENBQUMsS0FBSztLQUNyQixDQUFBO0FBQ0gsQ0FBQyxDQUFBO0FBbEJZLFFBQUEsa0JBQWtCLHNCQWtCOUI7QUFFTSxNQUFNLHNCQUFzQixHQUFHLENBQ3BDLEdBQWtCLEVBQ1EsRUFBRTtJQUM1QixNQUFNLE9BQU8sR0FBRyxJQUFBLDBCQUFrQixFQUFDLEdBQUcsQ0FBQyxDQUFBO0lBRXZDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNiLE1BQU0sSUFBSSxtQkFBVyxDQUNuQixtQkFBVyxDQUFDLEtBQUssQ0FBQyxZQUFZLEVBQzlCLHlDQUF5QyxDQUMxQyxDQUFBO0lBQ0gsQ0FBQztJQUVELE9BQU8sT0FBTyxDQUFBO0FBQ2hCLENBQUMsQ0FBQTtBQWJZLFFBQUEsc0JBQXNCLDBCQWFsQztBQUVNLE1BQU0sc0JBQXNCLEdBQUcsQ0FDcEMsR0FBbUIsRUFDbkIsS0FBYSxFQUNiLEVBQUU7SUFDRixNQUFNLFFBQVEsR0FBRyxHQUEwQixDQUFBO0lBQzNDLElBQUksT0FBTyxRQUFRLENBQUMsTUFBTSxLQUFLLFVBQVUsRUFBRSxDQUFDO1FBQzFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFLEtBQUssRUFBRSxjQUFjLENBQUMsQ0FBQTtRQUNuRCxPQUFNO0lBQ1IsQ0FBQztJQUVELE1BQU0sWUFBWSxHQUFHLEdBQUcsV0FBVyxJQUFJLEtBQUssYUFBYSxjQUFjLENBQUMsTUFBTSxxQkFDNUUsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUN2QyxHQUNFLGNBQWMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLGNBQWMsY0FBYyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUN0RSxFQUFFLENBQUE7SUFDRixHQUFHLENBQUMsU0FBUyxDQUFDLFlBQVksRUFBRSxZQUFZLENBQUMsQ0FBQTtBQUMzQyxDQUFDLENBQUE7QUFoQlksUUFBQSxzQkFBc0IsMEJBZ0JsQztBQUVNLE1BQU0sb0JBQW9CLEdBQUcsQ0FBQyxHQUFtQixFQUFFLEVBQUU7SUFDMUQsTUFBTSxRQUFRLEdBQUcsR0FBMEIsQ0FBQTtJQUMzQyxJQUFJLE9BQU8sUUFBUSxDQUFDLFdBQVcsS0FBSyxVQUFVLEVBQUUsQ0FBQztRQUMvQyxRQUFRLENBQUMsV0FBVyxDQUFDLFdBQVcsRUFBRTtZQUNoQyxHQUFHLGNBQWM7WUFDakIsTUFBTSxFQUFFLENBQUM7U0FDVixDQUFDLENBQUE7UUFDRixPQUFNO0lBQ1IsQ0FBQztJQUVELEdBQUcsQ0FBQyxTQUFTLENBQ1gsWUFBWSxFQUNaLEdBQUcsV0FBVyxpQ0FDWixjQUFjLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQ3ZDLEVBQUUsQ0FDSCxDQUFBO0FBQ0gsQ0FBQyxDQUFBO0FBaEJZLFFBQUEsb0JBQW9CLHdCQWdCaEMifQ==