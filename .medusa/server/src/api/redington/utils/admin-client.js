"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.adminFetch = void 0;
const utils_1 = require("@medusajs/framework/utils");
const ADMIN_BASE_URL = (process.env.MEDUSA_ADMIN_URL ||
    process.env.MEDUSA_BASE_URL ||
    process.env.MEDUSA_BACKEND_URL ||
    "http://localhost:9000")
    .trim()
    .replace(/\/+$/, "");
const ADMIN_TOKEN = (process.env.MEDUSA_ADMIN_TOKEN ||
    process.env.MEDUSA_ADMIN_API_KEY ||
    process.env.MEDUSA_SECRET_API_KEY ||
    "").trim();
const ensureAdminToken = () => {
    if (!ADMIN_TOKEN) {
        throw new utils_1.MedusaError(utils_1.MedusaError.Types.UNAUTHORIZED, "Missing MEDUSA_ADMIN_TOKEN environment variable.");
    }
};
const buildUrl = (path) => {
    const normalized = path.startsWith("/") ? path : `/${path}`;
    return `${ADMIN_BASE_URL}${normalized}`;
};
const normalizeHeaders = (init) => {
    const headers = {};
    const raw = init?.headers;
    const assignHeader = (key, value) => {
        headers[key] = value;
    };
    if (raw) {
        if (Array.isArray(raw)) {
            raw.forEach(([key, value]) => assignHeader(key, String(value)));
        }
        else if (typeof raw?.forEach === "function") {
            ;
            raw.forEach((value, key) => assignHeader(key, value));
        }
        else {
            Object.entries(raw).forEach(([key, value]) => assignHeader(key, String(value)));
        }
    }
    if (!headers["Accept"]) {
        headers["Accept"] = "application/json";
    }
    headers["Authorization"] = `Bearer ${ADMIN_TOKEN}`;
    headers["x-medusa-access-token"] = ADMIN_TOKEN;
    if (init?.body && !headers["Content-Type"]) {
        headers["Content-Type"] = "application/json";
    }
    return headers;
};
const parseResponseBody = async (response) => {
    const contentType = response.headers?.get?.("content-type") || "";
    if (contentType.includes("application/json")) {
        return response.json().catch(() => undefined);
    }
    const text = await response.text().catch(() => "");
    if (!text) {
        return undefined;
    }
    try {
        return JSON.parse(text);
    }
    catch (_) {
        return text;
    }
};
const adminFetch = async (path, init) => {
    ensureAdminToken();
    const response = await fetch(buildUrl(path), {
        ...init,
        headers: normalizeHeaders(init),
    });
    const payload = await parseResponseBody(response);
    if (!response.ok) {
        const message = (payload && typeof payload === "object" && "message" in payload
            ? payload.message
            : undefined) ||
            `Admin request failed with status ${response.status}`;
        throw new utils_1.MedusaError(utils_1.MedusaError.Types.UNEXPECTED_STATE, message);
    }
    return payload;
};
exports.adminFetch = adminFetch;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRtaW4tY2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2FwaS9yZWRpbmd0b24vdXRpbHMvYWRtaW4tY2xpZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHFEQUF1RDtBQUt2RCxNQUFNLGNBQWMsR0FBRyxDQUNyQixPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQjtJQUM1QixPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWU7SUFDM0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0I7SUFDOUIsdUJBQXVCLENBQ3hCO0tBQ0UsSUFBSSxFQUFFO0tBQ04sT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQTtBQUV0QixNQUFNLFdBQVcsR0FBRyxDQUNsQixPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQjtJQUM5QixPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQjtJQUNoQyxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQjtJQUNqQyxFQUFFLENBQ0gsQ0FBQyxJQUFJLEVBQUUsQ0FBQTtBQUVSLE1BQU0sZ0JBQWdCLEdBQUcsR0FBRyxFQUFFO0lBQzVCLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNqQixNQUFNLElBQUksbUJBQVcsQ0FDbkIsbUJBQVcsQ0FBQyxLQUFLLENBQUMsWUFBWSxFQUM5QixrREFBa0QsQ0FDbkQsQ0FBQTtJQUNILENBQUM7QUFDSCxDQUFDLENBQUE7QUFFRCxNQUFNLFFBQVEsR0FBRyxDQUFDLElBQVksRUFBRSxFQUFFO0lBQ2hDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQTtJQUMzRCxPQUFPLEdBQUcsY0FBYyxHQUFHLFVBQVUsRUFBRSxDQUFBO0FBQ3pDLENBQUMsQ0FBQTtBQUVELE1BQU0sZ0JBQWdCLEdB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