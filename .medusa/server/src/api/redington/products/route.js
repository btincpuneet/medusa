"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GET = void 0;
const admin_client_1 = require("../utils/admin-client");
const session_1 = require("../utils/session");
const respond_1 = require("../utils/respond");
const DEFAULT_LIMIT = Number(process.env.REDINGTON_PRODUCTS_LIMIT || 50);
const MAX_LIMIT = Number(process.env.REDINGTON_PRODUCTS_MAX_LIMIT || 200);
const pickQueryValue = (query, keys) => {
    const lookup = Array.isArray(keys) ? keys : [keys];
    for (const key of lookup) {
        const value = query?.[key];
        if (value === undefined || value === null) {
            continue;
        }
        if (Array.isArray(value)) {
            const candidate = value[0];
            if (candidate !== undefined && candidate !== null) {
                return String(candidate);
            }
            continue;
        }
        if (typeof value === "string") {
            if (value.trim().length === 0) {
                continue;
            }
            return value;
        }
        return String(value);
    }
    return undefined;
};
const parseNumberParam = (value, fallback) => {
    if (!value) {
        return fallback;
    }
    const parsed = Number(value);
    if (!Number.isFinite(parsed)) {
        return fallback;
    }
    return parsed;
};
const collectCategoryValues = (metadata) => {
    if (!metadata) {
        return [];
    }
    const candidates = metadata.magento_category_ids ||
        metadata.category_ids ||
        metadata.category_id ||
        null;
    if (!candidates) {
        return [];
    }
    if (Array.isArray(candidates)) {
        return candidates.map((candidate) => String(candidate).trim()).filter(Boolean);
    }
    if (typeof candidates === "string") {
        return candidates
            .split(",")
            .map((value) => value.trim())
            .filter(Boolean);
    }
    return [];
};
const simplifyProduct = (product) => {
    const primaryVariant = product.variants?.[0];
    const primaryPrice = primaryVariant?.prices?.[0];
    return {
        id: product.id,
        sku: product.handle || product.id,
        name: product.title || product.handle || "",
        price: typeof primaryPrice?.amount === "number" ? primaryPrice.amount : null,
        currency_code: primaryPrice?.currency_code,
        thumbnail: product.thumbnail ||
            primaryVariant?.metadata?.thumbnail ||
            null,
        metadata: product.metadata || {},
    };
};
const filterProducts = (products, query) => {
    const categoryFilter = pickQueryValue(query, ["category_id", "categoryId", "category"])?.trim();
    const skuFilter = pickQueryValue(query, "sku")?.trim().toLowerCase();
    const search = pickQueryValue(query, ["q", "search"])?.trim().toLowerCase();
    return products.filter((product) => {
        if (categoryFilter) {
            const categories = collectCategoryValues(product.metadata);
            if (!categories.some((category) => category === categoryFilter)) {
                return false;
            }
        }
        if (skuFilter && product.sku?.toLowerCase() !== skuFilter) {
            return false;
        }
        if (search) {
            const haystacks = [product.name || "", product.sku || ""].map((value) => value.toLowerCase());
            if (!haystacks.some((value) => value.includes(search))) {
                return false;
            }
        }
        return true;
    });
};
const GET = async (req, res) => {
    try {
        (0, session_1.requireCustomerSession)(req);
        const limitParam = pickQueryValue(req.query, "limit");
        const offsetParam = pickQueryValue(req.query, "offset");
        const limit = Math.min(Math.max(parseNumberParam(limitParam, DEFAULT_LIMIT), 1), MAX_LIMIT);
        const offset = Math.max(parseNumberParam(offsetParam, 0), 0);
        const forwarded = new URLSearchParams();
        forwarded.set("limit", limit.toString());
        forwarded.set("offset", offset.toString());
        forwarded.set("expand", "variants,variants.prices");
        const search = pickQueryValue(req.query, ["q", "search"]);
        if (search) {
            forwarded.set("q", search.trim());
        }
        const handleFilter = pickQueryValue(req.query, "sku");
        if (handleFilter) {
            forwarded.set("handle", handleFilter.trim());
        }
        const adminPath = `/admin/products?${forwarded.toString()}`;
        const response = await (0, admin_client_1.adminFetch)(adminPath);
        const items = Array.isArray(response?.products) ? response.products : [];
        const simplified = filterProducts(items.map(simplifyProduct), req.query);
        return res.json({
            items: simplified,
            count: simplified.length,
            limit,
            offset,
        });
    }
    catch (error) {
        return (0, respond_1.sendErrorResponse)(res, error, "Unable to load products.");
    }
};
exports.GET = GET;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvYXBpL3JlZGluZ3Rvbi9wcm9kdWN0cy9yb3V0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFQSx3REFBa0Q7QUFDbEQsOENBQXlEO0FBQ3pELDhDQUFvRDtBQUVwRCxNQUFNLGFBQWEsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyx3QkFBd0IsSUFBSSxFQUFFLENBQUMsQ0FBQTtBQUN4RSxNQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyw0QkFBNEIsSUFBSSxHQUFHLENBQUMsQ0FBQTtBQXVCekUsTUFBTSxjQUFjLEdBQUcsQ0FDckIsS0FBNkIsRUFDN0IsSUFBdUIsRUFDSCxFQUFFO0lBQ3RCLE1BQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUNsRCxLQUFLLE1BQU0sR0FBRyxJQUFJLE1BQU0sRUFBRSxDQUFDO1FBQ3pCLE1BQU0sS0FBSyxHQUFJLEtBQTZDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUNuRSxJQUFJLEtBQUssS0FBSyxTQUFTLElBQUksS0FBSyxLQUFLLElBQUksRUFBRSxDQUFDO1lBQzFDLFNBQVE7UUFDVixDQUFDO1FBQ0QsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDekIsTUFBTSxTQUFTLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBO1lBQzFCLElBQUksU0FBUyxLQUFLLFNBQVMsSUFBSSxTQUFTLEtBQUssSUFBSSxFQUFFLENBQUM7Z0JBQ2xELE9BQU8sTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFBO1lBQzFCLENBQUM7WUFDRCxTQUFRO1FBQ1YsQ0FBQztRQUNELElBQUksT0FB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