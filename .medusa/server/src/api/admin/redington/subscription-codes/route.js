"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GET = GET;
exports.POST = POST;
const pg_1 = require("../../../../lib/pg");
const normalizeString = (value) => typeof value === "string" ? value.trim() : "";
const normalizeEmail = (value) => typeof value === "string" ? value.trim().toLowerCase() : "";
const parseBoolean = (value) => {
    if (typeof value === "boolean") {
        return value;
    }
    if (typeof value === "string") {
        const normalized = value.trim().toLowerCase();
        if (["1", "true", "yes", "enable", "enabled"].includes(normalized)) {
            return true;
        }
        if (["0", "false", "no", "disable", "disabled"].includes(normalized)) {
            return false;
        }
    }
    return undefined;
};
const parseLimit = (value, fallback = 20) => {
    const parsed = Number.parseInt(String(value || ""), 10);
    if (!Number.isFinite(parsed) || parsed <= 0) {
        return fallback;
    }
    return Math.min(parsed, 200);
};
const parseOffset = (value) => {
    const parsed = Number.parseInt(String(value || ""), 10);
    if (!Number.isFinite(parsed) || parsed < 0) {
        return 0;
    }
    return parsed;
};
const sanitizeAccessId = (value) => value.replace(/[^0-9.]/g, "");
const buildSearchClause = (q, params) => {
    if (!q) {
        return { clause: "", params };
    }
    const like = `%${q}%`;
    params.push(like);
    const idx = `$${params.length}`;
    const clause = `(
    subscription_code ILIKE ${idx}
    OR company_code ILIKE ${idx}
    OR access_id ILIKE ${idx}
    OR first_name ILIKE ${idx}
    OR last_name ILIKE ${idx}
    OR email ILIKE ${idx}
  )`;
    return { clause, params };
};
async function GET(req, res) {
    await (0, pg_1.ensureRedingtonSubscriptionCodeTable)();
    const limit = parseLimit(req.query.limit);
    const offset = parseOffset(req.query.offset);
    const q = normalizeString(req.query.q);
    const statusFilter = parseBoolean(req.query.status);
    const params = [];
    const clauses = [];
    if (q) {
        const { clause } = buildSearchClause(q, params);
        if (clause) {
            clauses.push(clause);
        }
    }
    if (typeof statusFilter === "boolean") {
        params.push(statusFilter);
        clauses.push(`status = $${params.length}`);
    }
    const whereClause = clauses.length ? `WHERE ${clauses.join(" AND ")}` : "";
    const countResult = await (0, pg_1.getPgPool)().query(`
      SELECT COUNT(*) AS count
      FROM redington_subscription_code
      ${whereClause}
    `, params);
    const { rows } = await (0, pg_1.getPgPool)().query(`
      SELECT *
      FROM redington_subscription_code
      ${whereClause}
      ORDER BY created_at DESC
      LIMIT $${params.length + 1}
      OFFSET $${params.length + 2}
    `, [...params, limit, offset]);
    return res.json({
        subscription_codes: rows.map(pg_1.mapSubscriptionCodeRow),
        count: Number(countResult.rows?.[0]?.count || 0),
        limit,
        offset,
    });
}
async function POST(req, res) {
    await (0, pg_1.ensureRedingtonSubscriptionCodeTable)();
    const body = (req.body || {});
    const subscriptionCode = normalizeString(body.subscription_code);
    if (!subscriptionCode) {
        return res.status(400).json({ message: "subscription_code is required" });
    }
    const companyCode = normalizeString(body.company_code);
    if (!companyCode) {
        return res.status(400).json({ message: "company_code is required" });
    }
    const accessId = sanitizeAccessId(normalizeString(body.access_id));
    if (!accessId) {
        return res.status(400).json({ message: "access_id is required" });
    }
    const firstName = normalizeString(body.first_name);
    const lastName = normalizeString(body.last_name);
    const email = normalizeEmail(body.email);
    if (!firstName || !lastName || !email) {
        return res.status(400).json({
            message: "first_name, last_name, and email are required",
        });
    }
    const existing = await (0, pg_1.findSubscriptionCodeByCode)(subscriptionCode);
    if (existing) {
        return res.status(409).json({
            message: `Subscription code "${subscriptionCode}" already exists.`,
            subscription_code: existing,
        });
    }
    const status = typeof body.status === "boolean"
        ? body.status
        : parseBoolean(body.status) ?? true;
    const { rows } = await (0, pg_1.getPgPool)().query(`
      INSERT INTO redington_subscription_code (
        subscription_code,
        company_code,
        access_id,
        first_name,
        last_name,
        email,
        status
      )
      VALUES ($1, $2, $3, $4, $5, $6, $7)
      RETURNING *
    `, [
        subscriptionCode,
        companyCode,
        accessId,
        firstName,
        lastName,
        email,
        status,
    ]);
    const payload = {
        subscription_code: (0, pg_1.mapSubscriptionCodeRow)(rows[0]),
    };
    return res.status(201).json(payload);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9zcmMvYXBpL2FkbWluL3JlZGluZ3Rvbi9zdWJzY3JpcHRpb24tY29kZXMvcm91dGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFvRkEsa0JBb0RDO0FBRUQsb0JBeUVDO0FBak5ELDJDQU0yQjtBQVkzQixNQUFNLGVBQWUsR0FBRyxDQUFDLEtBQWMsRUFBRSxFQUFFLENBQ3pDLE9BQU8sS0FBSyxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUE7QUFFL0MsTUFBTSxjQUFjLEdBQUcsQ0FBQyxLQUFjLEVBQUUsRUFBRSxDQUN4QyxPQUFPLEtBQUssS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFBO0FBRTdELE1BQU0sWUFBWSxHQUFHLENBQUMsS0FBYyxFQUF1QixFQUFFO0lBQzNELElBQUksT0FBTyxLQUFLLEtBQUssU0FBUyxFQUFFLENBQUM7UUFDL0IsT0FBTyxLQUFLLENBQUE7SUFDZCxDQUFDO0lBQ0QsSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRLEVBQUUsQ0FBQztRQUM5QixNQUFNLFVBQVUsR0FBRyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFLENBQUE7UUFDN0MsSUFBSSxDQUFDLEdBQUcsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxTQUFTLENBQUMsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQztZQUNuRSxPQUFPLElBQUksQ0FBQTtRQUNiLENBQUM7UUFDRCxJQUFJLENBQUMsR0FBRyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLFVBQVUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENB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