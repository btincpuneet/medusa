"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.decryptUrlParams = exports.encryptUrlParams = void 0;
const crypto_1 = __importDefault(require("crypto"));
const SALTED_PREFIX = "Salted__";
const DEFAULT_SECRET_BASE64 = "1JDU4EmoOYnX0iiCixSjqvJRdMYFW8NPSjWJlcHZeXA=";
const resolveSecretKey = (override) => {
    if (override instanceof Buffer) {
        return override;
    }
    const candidate = (typeof override === "string" && override.trim().length
        ? override
        : process.env.REDINGTON_URL_CRYPTO_SECRET_KEY ||
            process.env.URL_CRYPTO_SECRET_KEY ||
            DEFAULT_SECRET_BASE64) || DEFAULT_SECRET_BASE64;
    const decoded = Buffer.from(candidate, "base64");
    if (!decoded.length) {
        throw new Error("URL crypto secret key is missing or invalid.");
    }
    return decoded;
};
const evpBytesToKey = (password, salt) => {
    let data = Buffer.alloc(0);
    let prev = Buffer.alloc(0);
    while (data.length < 48) {
        prev = crypto_1.default.createHash("md5").update(Buffer.concat([prev, password, salt])).digest();
        data = Buffer.concat([data, prev]);
    }
    return {
        key: data.subarray(0, 32),
        iv: data.subarray(32, 48),
    };
};
const buildQueryString = (params) => {
    const search = new URLSearchParams();
    search.append("access_code", String(params.access_code ?? "").trim());
    search.append("company_code", String(params.company_code ?? "").trim());
    search.append("country_code", String(params.country_code ?? "").trim());
    return search.toString();
};
const encryptUrlParams = (baseUrl, params, secretOverride) => {
    const trimmedBaseUrl = (baseUrl || "").trim();
    if (!trimmedBaseUrl.length) {
        throw new Error("Web URL is missing");
    }
    const secret = resolveSecretKey(secretOverride);
    const salt = crypto_1.default.randomBytes(8);
    const { key, iv } = evpBytesToKey(secret, salt);
    const query = buildQueryString(params);
    const cipher = crypto_1.default.createCipheriv("aes-256-cbc", key, iv);
    const encrypted = Buffer.concat([cipher.update(query, "utf8"), cipher.final()]);
    const payload = Buffer.concat([Buffer.from(SALTED_PREFIX), salt, encrypted]).toString("base64");
    const encoded = encodeURIComponent(payload);
    const separator = trimmedBaseUrl.includes("?") ? "&" : "?";
    const encryptedUrl = `${trimmedBaseUrl}${separator}q=${encoded}`;
    return {
        encryptedUrl,
        q: payload,
        params,
        query,
    };
};
exports.encryptUrlParams = encryptUrlParams;
const parseParams = (query) => {
    const search = new URLSearchParams(query);
    return {
        access_code: search.get("access_code") ?? "",
        company_code: search.get("company_code") ?? "",
        country_code: search.get("country_code") ?? "",
    };
};
const decryptUrlParams = (encrypted, secretOverride) => {
    const raw = (encrypted || "").trim();
    if (!raw.length) {
        return null;
    }
    let decoded;
    try {
        decoded = Buffer.from(raw, "base64");
    }
    catch {
        return null;
    }
    if (!decoded.length || decoded.subarray(0, 8).toString("utf8") !== SALTED_PREFIX) {
        return null;
    }
    const salt = decoded.subarray(8, 16);
    const ciphertext = decoded.subarray(16);
    const secret = resolveSecretKey(secretOverride);
    const { key, iv } = evpBytesToKey(secret, salt);
    try {
        const decipher = crypto_1.default.createDecipheriv("aes-256-cbc", key, iv);
        const decrypted = Buffer.concat([decipher.update(ciphertext), decipher.final()]);
        const queryString = decrypted.toString("utf8");
        return parseParams(queryString);
    }
    catch {
        return null;
    }
};
exports.decryptUrlParams = decryptUrlParams;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXJsLWNyeXB0by5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9saWIvdXJsLWNyeXB0by50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxvREFBMkI7QUFVM0IsTUFBTSxhQUFhLEdBQUcsVUFBVSxDQUFBO0FBQ2hDLE1BQU0scUJBQXFCLEdBQUcsOENBQThDLENBQUE7QUFFNUUsTUFBTSxnQkFBZ0IsR0FBRyxDQUFDLFFBQXVCLEVBQVUsRUFBRTtJQUMzRCxJQUFJLFFBQVEsWUFBWSxNQUFNLEVBQUUsQ0FBQztRQUMvQixPQUFPLFFBQVEsQ0FBQTtJQUNqQixDQUFDO0lBRUQsTUFBTSxTQUFTLEdBQ2IsQ0FBQyxPQUFPLFFBQVEsS0FBSyxRQUFRLElBQUksUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDLE1BQU07UUFDckQsQ0FBQyxDQUFDLFFBQVE7UUFDVixDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQywrQkFBK0I7WUFDM0MsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUI7WUFDakMscUJBQXFCLENBQUMsSUFBSSxxQkFBcUIsQ0FBQTtJQUVyRCxNQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxRQUFRLENBQUMsQ0FBQTtJQUNoRCxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ3BCLE1BQU0sSUFBSSxLQUFLLENBQUMsOENBQThDLENBQUMsQ0FBQTtJQUNqRSxDQUFDO0lBRUQsT0FBTyxPQUFPLENBQUE7QUFDaEIsQ0FBQyxDQUFBO0FBRUQsTUFBTSxhQUFhLEdBQUcsQ0FBQyxRQUFnQixFQUFFLElBQVksRUFBRSxFQUFFO0lBQ3ZELElBQUksSUFBSSxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDMUIsSUFBSSxJQUFJLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUUxQixPQUFP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